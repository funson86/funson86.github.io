---
title: Mysql源码分析2 - 事务
categories:
 - 源码分析 
tags:
 - mysql源码分析
---

## mysql事务分析

### 事务ACID特性
事务是由一组SQL语句组成的逻辑处理单元，事务具有以下4个属性，通常简称为事务的ACID属性。

- 原子性（Atomicity）：事务是一个原子操作单元，其对数据的修改，要么全都执行，要么全都不执行。
- 一致性（Consistent）：在事务开始和完成时，数据都必须保持一致状态。这意味着所有相关的数据规则都必须应用于事务的修改，以保持数据的完整性；事务结束时，所有的内部数据结构（如B树索引或双向链表）也都必须是正确的。
- 隔离性（Isolation）：数据库系统提供一定的隔离机制，保证事务在不受外部并发操作影响的“独立”环境执行。这意味着事务处理过程中的中间状态对外部是不可见的，反之亦然。
- 持久性（Durable）：事务完成之后，它对于数据的修改是永久性的，即使出现系统故障也能够保持。

### 并发事务存在的问题

当有多个事务并发处理，会带来一些问题：

- 更新丢失（Lost Update）：当两个或多个事务选择同一行，然后基于最初选定的值更新该行时，由于每个事务都不知道其他事务的存在，就会发生丢失更新问题－－最后的更 新覆盖了由其他事务所做的更新。例如，两个编辑人员制作了同一文档的电子副本。每个编辑人员独立地更改其副本，然后保存更改后的副本，这样就覆盖了原始文 档。最后保存其更改副本的编辑人员覆盖另一个编辑人员所做的更改。如果在一个编辑人员完成并提交事务之前，另一个编辑人员不能访问同一文件，则可避免此问 题。
- 脏读（Dirty Reads）：一个事务正在对一条记录做修改，在这个事务完成并提交前，这条记录的数据就处于不一致状态；这时，另一个事务也来读取同一条记录，如果不加 控制，第二个事务读取了这些“脏”数据，并据此做进一步的处理，就会产生未提交的数据依赖关系。这种现象被形象地叫做"脏读"。
- 不可重复读（Non-Repeatable Reads）：一个事务在读取某些数据后的某个时间，再次读取以前读过的数据，却发现其读出的数据已经发生了改变、或某些记录已经被删除了！这种现象就叫做“不可重复读”。
- 幻读（Phantom Reads）：一个事务按相同的查询条件重新读取以前检索过的数据，却发现其他事务插入了满足其查询条件的新数据，这种现象就称为“幻读”。

### 事务隔离级别
表级别锁有两种，一种表锁，一种为元数据锁(MDL lock, meta data lock)

- READ UNCOMMITTED 读未提交

其他事务未提交的数据也能读取，实际应用中很少使用。


- READ COMMITTED 读已提交

事务直到提交之前，所做的任何修改对其他事务不可见的。


- REPEATABLE READ 可重复读 (MYSQL默认级别)
解决不可重复读问题，多次读取同一条记录得到相同的值。

但是没有解决幻读问题（某个事务读取某个范围的记录时，另外一个事务插入一条数据，前事务再次读取范围记录时产生幻行）

InnoDB和XtraDB存储引擎通过MVCC和间隙锁解决幻读问题。


- SERIALIZABLE 串行化
最高级别，强制事务串行执行，可以避免并发事务的所有问题包括幻读。会在读取的每一行数据加锁，可能导致大量的超时和锁争用。很少使用



### InnoDB多版本并发控制MVCC
通过在每条记录后面保存两个隐藏的列来实现

- 一个保存行创建时间（系统版本号） 每开始一个新的事务，系统版本号自动增加
- -个保存行删除时间（系统版本号，即该版本号之前有效）


通过这两个字段，在REPEATABLE READ隔离级别下，MVCC具体操作过程：

- INSERT 为新插入的每一行保存当前系统版本号为行版本号
- DELETE 为删除的每一行保存当前系统版本号为行删除标识
- UPDATE 执行上述2个动作，新增加一条记录保存当前系统版本号为行版本号  保存当前系统版本号到原数据的行删除标识
- SELECT 根据两个条件检查每行数据 1.系统版本号小于当前事务版本号  2.行删除标识要么未定义，要么大于当前版本号

优点：大多数读操作不用加锁

缺点：每行记录需要额外的存储空间

[InnoDB MVCC实现原理及源码解析](https://blog.csdn.net/yanzongshuai/article/details/79949332)





